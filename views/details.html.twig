{% extends 'layout.html.twig' %}
 
{% block content %}
{% if not user %}
<div class="alert alert-block alert-info">If you are the owner of this crash, <a href="{{ path('login', {'return': app.request.pathInfo}) }}">login</a> to see more information.</div>
{% endif %}

{% if crash.processed == 0 %}
<div class="alert alert-block alert-info">This crash is pending processing, try again later.</div>
{% elseif crash.failed == 1 %}
<div class="alert alert-block alert-error">An error occurred while processing this crash.</div>
{% endif %}

<div class="well">
    <dl class="dl-horizontal">
        <dt>Uploaded</dt>
        <dd>{{ crash.timestamp|date }}</dd>
{% if user and (user.admin or user.id == crash.owner) %}
{% if crash.cmdline %}
        <dt>Command Line</dt>
        <dd>{{ crash.cmdline }}</dd>
{% endif %}
{% for key, value in crash.metadata %}
        <dt>{{ key|decamel }}</dt>
{% if value %}
        <dd>{{ value }}</dd>
{% else %}
        <dd>&nbsp;</dd>
{% endif %}
{% endfor %}
{% endif %}
    </dl>
</div>

{% if user and (user.admin or user.id == crash.owner) %}
<div class="well">
    <a class="btn" href="{{ path('download', {'id': crash.id}) }}"><i class="icon-download"></i> Download</a>
{% if user.admin %}
    <div class="pull-right">
        <a class="btn" href="{{ path('logs', {id: crash.id}) }}"><i class="icon-cogs"></i> View Logs</a>
        <form action="{{ path('reprocess', {id: crash.id, return: app.request.pathInfo}) }}" method="post" class="button-form">
            <button type="submit" class="btn"><i class="icon-refresh"></i> Reprocess</button>
        </form>
        <form action="{{ path('delete', {id: crash.id}) }}" method="post" class="button-form">
            <button type="submit" class="btn btn-danger"><i class="icon-trash"></i> Delete</button>
        </form>
    </div>
{% endif %}
</div>
{% endif %}

{% if crash.processed == 1 and crash.failed == 0 %}
{% for notice in notices %}
<div class="alert alert-block alert-{{ notice.severity }}">{{ notice.text|raw }}</div>
{% endfor %}

<h2>Stack Trace</h2>
<div class="well well-tight">
    <table class="table table-stacktrace table-shown">
        <thead>
            <tr>
                <th></th>
                <th>Function</th>
            </tr>
        </thead>
        <tbody>
{% for frame in stack %}
            <tr>
                <th>{{ frame.frame }}</th>
                <td class="monospace column-stackframe">{{ frame.rendered }}</td>
            </tr>
{% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="2"><i class="icon-ellipsis-horizontal"></i></td>
            </tr>
        </tfoot>
    </table>
</div>

<h2>Modules</h2>
<div class="well well-tight">
    <table class="table table-modules table-shown">
        <thead>
            <tr>
                <th>Name</th>
                <th>Identifier</th>
            </tr>
        </thead>
        <tbody>
{% for module in modules %}
{% set class = ((module.identifier == '000000000000000000000000000000000') ? 'info' : (module.processed ? '' : (module.present ? 'warning' : 'error'))) %}
            <tr class="{{ class }}">
                <td>{{ module.name }}</td>
                <td class="monospace">{{ module.identifier }}</td>
            </tr>
{% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="2"><i class="icon-ellipsis-horizontal"></i></td>
            </tr>
        </tfoot>
    </table>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ app.request.baseUrl }}/js/jquery.hoverIntent.min.js"></script>
<script type="text/javascript">
    $('.table-stacktrace tbody tr').hoverIntent(function() { $(this).toggleClass('stackframe-expand'); });

    $('.table-shown').each(function() {
        if ($(this).find('tbody tr').length <= 10) {
            return;
        }

        $(this).toggleClass('table-shown').toggleClass('table-hidden').find('tfoot').click(function() {
            $(this).parent().toggleClass('table-hidden').toggleClass('table-shown');
        });
    });
</script>
{% endblock %}

