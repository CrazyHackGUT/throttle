{% extends 'layout.html.twig' %}
 
{% block content %}
{% if module %}
<div class="well well-tight">
  <ol class="breadcrumb">
{% if function %}
    <li><a href="{{ path('stats') }}">Stats</a></li>
    <li><a href="{{ path('stats', {module: module}) }}">{{ module }}</a></li>
    <li class="active">{{ function }}</li>
{% else %}
    <li><a href="{{ path('stats') }}">Stats</a></li>
    <li class="active">{{ module }}</li>
{% endif %}
  </ol>
</div>
{% endif %}
<h2>Crash Dumps / Day</h2>
<div class="well well-sm">
  <div id="chart_daily" style="width:100%; height:300px;"></div>
</div>
<h2>Top Crashers</h2>
<div class="well well-tight">
  <table id="table_top" class="table table-stacktrace">
    <thead><tr><th></th><th>Function</th><th></th></tr></thead>
  </table>
</div>
<h2>Latest Crash Dumps</h2>
<div class="well well-tight">
  <table id="table_latest" class="table">
    <thead><tr><th></th><th></th><th>Function</th></tr></thead>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ app.request.baseUrl }}/js/highcharts.js"></script>
<script src="{{ app.request.baseUrl }}/js/highcharts.data.js"></script>
<script type="text/javascript">
$(function() {
  $.get('{{ path('stats_daily', {module: module, function: function}) }}', function(csv) {
    $('#chart_daily').highcharts({
      data: {
        csv: csv,
        parseDate: function(s) {
          var match = s.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})$/);
          if (match) {
            return Date.UTC(+match[1], match[2] - 1, +match[3]);
          }
        },
      },
      title: {
        text: '',
      },
      xAxis: {
        type: 'datetime',
      },
      yAxis: {
        title: {
          text: '',
        },
        allowDecimals: false,
        min: 0,
      },
      legend: {
        enabled: false,
      },
      credits: {
        enabled: false,
      },
    });
  });

  $.getJSON('{{ path('stats_top', {module: module, function: function}) }}', function(data) {
    var table_body = '';

    for (var i = 0; i < data.length; i++) {
      table_body += '<tr><th>'+(i+1)+'</th><td class="monospace">';

      if (data[i][0]) {
        table_body += data[i][0];
      } else {
        table_body += '<em>Unknown</em>';
      }

      table_body += '</td><th>';

      var show_link = !!({% if module %}data[i][3]{% else %}data[i][2]{% endif %});

      if (show_link) {
        table_body += '<a href="{{ path('stats') }}/'+encodeURIComponent(data[i][2]);

        if (data[i][3]) table_body += '/'+encodeURIComponent(data[i][3]);

        table_body += '">';
      }

      table_body += data[i][1];

      if (show_link) table_body += '</a>';

      table_body += '</th></tr>';
    }

    $('#table_top').append(table_body);
  });

  function identicon(hash) {
    return 'https://secure.gravatar.com/avatar/' + hash + '?s=40&r=any&default=identicon&forcedefault=1';
  }

  $.getJSON('{{ path('stats_latest', {module: module, function: function}) }}', function(data) {
    var table_body = '';

    for (var i = 0; i < data.length; i++) {
      table_body += '<tr><td><div class="column-iconstack">';

      if (data[i][2]) {
        table_body += '<img class="column-identicon" src="'+identicon(data[i][2])+'" width="20" height="20">';
      }

      if (data[i][3]) {
        table_body += '<img class="column-identicon" src="'+data[i][3]+'" width="20" height="20">';
      }

      table_body += '</div></td><th class="monospace"><a href="/'+data[i][0]+'">'+(data[i][0].toUpperCase().match(/.{4}/g).join('-'))+'</a></th><td class="monospace">';

      if (data[i][1]) {
        table_body += data[i][1];
      } else {
        table_body += '<em>Unknown</em>';
      }

      table_body += '</td></tr>';
    }

    $('#table_latest').append(table_body);
  });
});
</script>
{% endblock %}

